# Создание инфраструктуры

## Начало работы с Terraform

Подробное руководство есть [на сайте Яндекса](https://cloud.yandex.ru/ru/docs/tutorials/infrastructure-management/terraform-quickstart). После установки приложения и настройки зеркала для установки провайдеров (если требуется), нужно инициализировать рабочий каталог Terraform с помощью команды `init`:

    cd slurm_terraform_practice/slurm-tf-final-project/terraform
    terraform init

Используются провайдеры Yandex (само собой) и TLS (для генерации SSH-пар ключей).

## Создание инфраструктуры

На этом этапе должны быть известны [параметры подключения к облаку](/slurm-tf-final-project/PREPARE.md#параметры).

### Переменные

Могут быть определены следующие переменные:

|Переменная|Дефолт|Описание|
|---|---|---|
|token|`""`| Токен авторизации в Яндекс.Облаке. По умолчанию берется из переменной окружения YC_TOKEN.|
|cloud_id|`""`| Идентификатор личного облака. По умолчанию берется из переменной окружения YC_CLOUD_ID. |
|folder_id|`""`| Идентификатор каталога в облаке. Если используется вспомогательный скрипт, то в окружении будет соответствующая переменная `TF_VAR_folder_id`. |
|az|<ul><li>`ru-central1-a`</li><li>`ru-central1-b`</li><li>`ru-central1-d`</li></ul>| Список зон доступности (по умолчанию используются все зоны, за исключением не рекомендованной самим Яндексом зоны `C`) |
|cidr_blocks|-| Список списков префиксов в CIDR-нотации для использования в подсетях. |
|resources|-| Объект с перечислением параметров ресурсов, используемых при создании виртуальных машин (процессор, память и т. д.) |
|image_family|-| Семейство образов загрузочных дисков, которое используемое при создании машины (будет найден и выбран самый последний доступный образ из семейства). |
|public_ssh_key_path|-| Путь к публичному ключу SSH, который будет добавлен в создаваемые виртуальные машины. Если не указан, то будет создан случайный. |
|vm_number|`-1`| Количество виртуальных машин, которые будут созданы в рамках `instance_group`. При дефолтном значении `-1` будет создано машин по количеству зон доступности (`az`). |

## Выполнение

Перед непосредственным выполнением желательно проверить корректность конфигурации и внести правки. Для этого используется команда `plan`:

    cd slurm_terraform_practice/slurm-tf-final-project/terraform
    terraform plan -var-file=var.tfvars

Команда для создания (изменения) инфраструктуры:

    cd slurm_terraform_practice/slurm-tf-final-project/terraform
    terraform apply -auto-approve -var-file=var.tfvars

Команда для удаления созданной инфраструктуры:

    cd slurm_terraform_practice/slurm-tf-final-project/terraform
    terraform destroy -auto-approve -var-file=var.tfvars
